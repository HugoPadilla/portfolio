---
import {getCollection} from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import ProjectCard from '../components/ProjectCard.astro';
import ProjectCaseStudy from '../components/ProjectCaseStudy.astro';

const projectsCollection = await getCollection('projects');
const projects = projectsCollection.map(p => ({
  ...p.data,
  slug: p.slug, // Pass slug explicitly
  link: `javascript:openModal('${p.slug}')`
}));

// Add Coming Soon placeholder
projects.push({
  title: "Próximo Proyecto",
  description: "Actualmente trabajando en una auditoría de seguridad para una fintech líder en la región. Detalles confidenciales por el momento.",
  tags: ["Consultoría", "Coming Soon"],
  icon: "rocket_launch",
  isComingSoon: true,
  subtitle: "",
  slug: "coming-soon"
} as any);

const filters = ["Todos", "Flutter", "Android Nativo", "Seguridad", "Arquitectura"];
---

<Layout title="Todos los Proyectos | Hugo Javier Padilla Cavadia">
    <Navbar/>

    <main class="min-h-screen">
        <!-- Header -->
        <header class="pt-32 pb-12 lg:pt-40 lg:pb-16 bg-background-light dark:bg-background-dark">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="max-w-3xl">
                    <div class="inline-flex items-center px-3 py-1 mb-6 rounded-full border border-primary/30 bg-primary/10 text-primary text-xs font-semibold uppercase tracking-wider">
                        Portfolio
                    </div>
                    <h1 class="font-display text-4xl lg:text-6xl font-bold leading-tight text-text-light dark:text-text-dark mb-6">
                        Todos los <span class="text-primary">Proyectos</span>
                    </h1>
                    <p class="text-lg text-muted-light dark:text-muted-dark leading-relaxed">
                        Una colección curada de soluciones móviles enfocadas en arquitectura escalable, seguridad
                        biométrica y optimización de rendimiento para entornos corporativos y startups.
                    </p>
                </div>
            </div>
        </header>

        <!-- Contextual Navigation / Filters -->
        <section
                class="sticky top-20 z-40 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm border-b border-gray-200 dark:border-border-dark py-4 transition-colors duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-auto no-scrollbar">
                <div class="flex space-x-2 md:space-x-4 min-w-max">
                  {filters.map((filter, index) => (
                          <button
                                  class={`px-6 py-2 rounded-full text-sm font-semibold transition-all ${
                                    index === 0
                                      ? "bg-primary text-gray-900 border border-primary shadow-lg shadow-primary/20"
                                      : "bg-transparent text-muted-light dark:text-muted-dark border border-gray-300 dark:border-gray-700 hover:border-primary dark:hover:border-primary hover:text-text-light dark:hover:text-text-dark"
                                  }`}
                          >
                            {filter}
                          </button>
                  ))}
                </div>
            </div>
        </section>

        <!-- Projects Grid -->
        <section class="py-32 lg:py-24 bg-background-light dark:bg-background-dark min-h-screen">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-12">
                  {projects.map((project) => (
                          <ProjectCard {...project}/>
                  ))}
                </div>
            </div>
        </section>
    </main>

    <Footer/>

    <!-- Project Modals (Prerendered for instant access) -->
  {projectsCollection.map(project => (
          <dialog id={`modal-${project.slug}`}
                  class="modal-case-study fixed inset-0 z-[100] w-full h-full max-h-screen max-w-full bg-background-dark text-white p-0 m-0 border-none outline-none overflow-hidden backdrop:bg-black/80">
              <div class="h-full w-full overflow-y-auto relative no-scrollbar">
                  <!-- Close Button -->
                  <button
                          onclick={`closeModal('${project.slug}')`}
                          class="fixed top-6 right-6 z-[110] w-14 h-14 bg-black/50 backdrop-blur-md rounded-full flex items-center justify-center text-white border border-white/10 hover:bg-primary hover:text-black hover:scale-110 transition-all duration-300 group"
                  >
                      <span class="material-icons-outlined text-3xl group-hover:rotate-90 transition-transform">close</span>
                  </button>

                  <ProjectCaseStudy project={project}/>
              </div>
          </dialog>
  ))}
</Layout>

<script is:inline>
  // Handle opening modals
  function openModal(slug) {
    if (slug === 'coming-soon') return;

    const modal = document.getElementById(`modal-${slug}`);
    if (modal) {
      modal.showModal();
      document.body.style.overflow = 'hidden'; // Lock Body Scroll

      // Update URL for sharability (optional but nice)
      const newUrl = `/projects/${slug}`;
      window.history.pushState({modalOpen: true, slug}, '', newUrl);
    }
  }

  // Handle closing modals
  function closeModal(slug) {
    const modal = document.getElementById(`modal-${slug}`);
    if (modal) {
      modal.close();
      document.body.style.overflow = ''; // Unlock Body Scroll

      // Revert URL
      window.history.pushState({}, '', '/projects');
    }
  }

  // Handle Browser Back Button
  window.addEventListener('popstate', (event) => {
    // If back button pressed, close all modals
    document.querySelectorAll('dialog[open]').forEach(dialog => {
      dialog.close();
      document.body.style.overflow = '';
    });
  });

  // Close on backdrop click
  document.addEventListener('click', (event) => {
    // Only trigger if clicking exactly on the dialog element (backdrop)
    // Check if the modal logic handles backdrop clicks native to <dialog>
    if (event.target.tagName === 'DIALOG') {
      event.target.close();
      document.body.style.overflow = '';
      window.history.pushState({}, '', '/projects');
    }
  });
</script>

<style>
/* Modal Animation */
dialog {
  opacity: 0;
  transform: scale(0.95) translateY(20px);
  transition: opacity 0.3s ease-out, transform 0.3s ease-out, display 0.3s allow-discrete;
  }

dialog[open] {
  opacity: 1;
  transform: scale(1) translateY(0);
  display: block;
  }

@starting-style {
  dialog[open] {
  opacity: 0;
  transform: scale(0.95);
  }
  }

/* Hide scrollbar for Chrome, Safari and Opera */
.no-scrollbar::-webkit-scrollbar {
  display: none;
  }
/* Hide scrollbar for IE, Edge and Firefox */
.no-scrollbar {
  -ms-overflow-style: none; /* IE and Edge */
  scrollbar-width: none; /* Firefox */
  }
</style>
